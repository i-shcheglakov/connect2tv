#!/bin/bash
# Author: Igor Shcheglakov (i.shcheglako@samsung.com)

OPTION_CONNECT_ONLY=
OPTION_IP_ADDR=
RPMFILE="com.samsung.tv.vnc-1.0.0-1.armv7l.rpm"
PACKAGE_NAME="com.samsung.tv.vnc"

function usage()
{
  echo "Usage: $0 [-c|--connect-only] [-i|-ip-addr IPADDR]"
}

# Parse command line arguments
function parse_cmd()
{
  for ARG in "$@"; do
    case "$ARG" in
      -c|--connect-only)
        OPTION_CONNECT_ONLY="True"
        ;;
      -i|--ip-addr=*)
        OPTION_IP_ADDR=${ARG#*=}
        ;;
      vnc)
        RPMFILE="com.samsung.tv.vnc-1.0.0-1.armv7l.rpm"
        PACKAGE_NAME="com.samsung.tv.vnc"
        ;;
      rdp)
        RPMFILE="org.tizen.efreerdp-2.0.0-1.armv7l.rpm"
        PACKAGE_NAME="org.tizen.efreerdp"
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        echo "Unknown argument: $ARG" >&2
        usage
        exit 1
        ;;
    esac
  done
}

parse_cmd $@

# Figure out current default profile in ~/.gbs.conf
BUILD_PROFILE=`sed -n 's/profile = profile.\(.*\)$/\1/p' ~/.gbs.conf`

# Discover IP address based on the default profile
if [ -z "$OPTION_IP_ADDR" ]; then

  case "$BUILD_PROFILE" in
    muse.m.iwb.main.5.0)
      OPTION_IP_ADDR="106.125.38.173"
      ;;
    kantm2.lfd.5.0)
      OPTION_IP_ADDR="106.125.40.215"
      ;;
    *)
      echo "Profile-based IP discovery failed. Set -i option." >&2
      exit 1
  esac

fi

sdb connect "$OPTION_IP_ADDR"
sdb -s "$OPTION_IP_ADDR" root on

if [ "x$OPTION_CONNECT_ONLY" != "x" ]; then
  exit 0
fi

# Push RPM package onto the device
sdb -s "$OPTION_IP_ADDR" push "$HOME/GBS-ROOT/local/repos/$BUILD_PROFILE/armv7l/RPMS/$RPMFILE" /tmp
# Reinstall the package
sdb -s "$OPTION_IP_ADDR" shell rpm -e "$PACKAGE_NAME"
sdb -s "$OPTION_IP_ADDR" shell rpm -ivh --force --nodeps "/tmp/$RPMFILE"
